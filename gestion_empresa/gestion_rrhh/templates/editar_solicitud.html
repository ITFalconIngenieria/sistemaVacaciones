{% extends 'base.html' %}
{% load crispy_forms_tags %}
{% block title %}Editar Solicitud{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="card-header bg-warning text-white">
        <h4 class="mb-0">Editar Solicitud</h4>
    </div>
    <form method="post">
        {% csrf_token %}
        {{ form|crispy }}
        <div class="alert alert-info" id="dias-solicitados">
            La cantidad de días solicitados es:  días.
        </div>
        <div class="alert alert-info" id="horas-solicitadas">
            La cantidad de horas solicitadas es:  horas.
        </div>
        <button type="submit" class="btn btn-primary">Guardar Cambios</button>
        <a href="{% url 'mis_solicitudes' %}" class="btn btn-secondary">Cancelar</a>
    </form>
</div>


<script>
    document.addEventListener('DOMContentLoaded', function () {
        const tipoSelect = document.getElementById('id_tipo');
        const fechaFinInput = document.getElementById('id_fecha_fin');
        const fechaInicioInput = document.getElementById('id_fecha_inicio');
        const diasSolicitadosInfo = document.getElementById('dias-solicitados');
        const horasSolicitadasInfo = document.getElementById('horas-solicitadas');

        flatpickr('.flatpickr-datetime', {
            enableTime: true,
            dateFormat: 'Y-m-d H:i',
            time_24hr: true,
            locale: 'es'
        });

        function calcularHorasSolicitadas() {
            const fechaInicio = new Date(fechaInicioInput.value);
            const fechaFin = new Date(fechaFinInput.value);

            if (fechaInicio && fechaFin && fechaFin >= fechaInicio) {
                let diferenciaTiempo = fechaFin - fechaInicio;
                let horas = diferenciaTiempo / (1000 * 60 * 60);

                const almuerzoInicio = new Date(fechaInicio);
                almuerzoInicio.setHours(12, 0, 0, 0);

                const almuerzoFin = new Date(fechaInicio);
                almuerzoFin.setHours(13, 0, 0, 0);

                if (fechaInicio <= almuerzoInicio && fechaFin >= almuerzoFin) {
                    horas -= 1;
                }

                horasSolicitadasInfo.textContent = `La cantidad de horas solicitadas es: ${Math.round(horas * 100) / 100} horas.`;
            } else {
                horasSolicitadasInfo.textContent = `La cantidad de horas solicitadas es: 0 horas.`;
            }
        }

        function calcularDiasSolicitados() {
        const fechaInicio = new Date(fechaInicioInput.value);
        const fechaFin = new Date(fechaFinInput.value);

        // Set the time component to midnight (00:00:00) for both dates
        fechaInicio.setHours(0, 0, 0, 0);
        fechaFin.setHours(0, 0, 0, 0);

        if (fechaInicio && fechaFin && fechaFin >= fechaInicio) {
            const diferenciaTiempo = fechaFin - fechaInicio;
            const dias = Math.ceil(diferenciaTiempo / (1000 * 60 * 60 * 24)) + 1;
            diasSolicitadosInfo.textContent = `La cantidad de días solicitados es: ${dias} días.`;
        } else {
            diasSolicitadosInfo.textContent = `La cantidad de días solicitados es: 0 días.`;
        }
        }

        function actualizarCalculos() {
            if (tipoSelect.value === 'V') {
                calcularDiasSolicitados();
            } else if (tipoSelect.value === 'HC') {
                calcularHorasSolicitadas();
            }
        }

        function mostrarOcultarDiasHoras() {
            if (tipoSelect.value === 'V') {
                diasSolicitadosInfo.style.display = 'block';
                horasSolicitadasInfo.style.display = 'none';
                calcularDiasSolicitados();
            } else if (tipoSelect.value === 'HE' || tipoSelect.value === 'HC') {
                diasSolicitadosInfo.style.display = 'none';
                horasSolicitadasInfo.style.display = 'block';
                calcularHorasSolicitadas();
            } else {
                diasSolicitadosInfo.style.display = 'none';
                horasSolicitadasInfo.style.display = 'none';
            }
        }

        mostrarOcultarDiasHoras();
        tipoSelect.addEventListener('change', mostrarOcultarDiasHoras);
        fechaInicioInput.addEventListener('change', actualizarCalculos);
        fechaFinInput.addEventListener('change', actualizarCalculos);
    });
</script>
{% endblock %}
